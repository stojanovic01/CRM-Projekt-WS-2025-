{% extends "base.html" %}
{% block content %}

<div class="detail-card">
    <h2>Kunde: {{ customer.first_name or '—' }} {{ customer.last_name or '—' }} (Kund# {{ customer.id }})</h2>
    <div class="detail-row">
        <div class="contact-inline">
            Kontakt: {{ customer.email or '—' }}, {{ customer.phone or '—' }}
        </div>
        <div class="last-contact-inline">
            {% if last_conversations and last_conversations[0] %}
                • Letzte Konversation: {{ last_conversations[0].conversation_time and last_conversations[0].conversation_time.strftime('%Y-%m-%d %H:%M') or '—' }}
                ({{ last_conversations[0].channel or '—' }})
            {% else %}
                • Keine Konversation vorhanden
            {% endif %}
        </div>
    </div>

    <hr>

    <div class="kpis">
        <div><strong>KPIs:</strong></div>
        <div>Umsatz gesamt: {{ total_revenue or 0 | round(2) }}</div>
        <div>Umsatz letztes Jahr: {{ last_year_revenue or 0 | round(2) }}</div>
    </div>

    <form method="GET" action="{{ url_for('customers.customer_detail', customer_id=customer.id) }}" class="date-range-form">
        <label>Datumsbereich:</label>
        <input type="date" name="start" value="{{ start or '' }}">
        <input type="date" name="end" value="{{ end or '' }}">
        <button type="submit" class="btn btn-primary">Anwenden</button>
        <a class="btn btn-secondary" href="{{ url_for('customers.customer_detail', customer_id=customer.id) }}">Zurücksetzen</a>
    </form>

    <div class="tabs">
        <a href="#orders" class="tab">Letzte Bestellungen</a>
        <a href="#contacts" class="tab">Letzte Konversationen</a>
        <a href="#master" class="tab">Stammdaten</a>
    </div>

    <section id="orders">
        <h3>Letzte Bestellungen</h3>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Bestell#</th>
                        <th>Datum</th>
                        <th>Positionen</th>
                        <th>Status</th>
                        <th>Summe</th>
                    </tr>
                </thead>
                <tbody>
                    {% if last_orders %}
                        {% for order in last_orders %}
                        <tr>
                            <td>{{ 'A-' ~ (10000 + (order.id or 0)) }}</td>
                            <td>{{ order.order_date and order.order_date.strftime('%Y-%m-%d') or '—' }}</td>
                            <td>{{ order.items | length if order.items else 0 }}</td>
                            <td>{{ order.status or '—' }}</td>
                            <td>{{ order.total_amount or 0 | round(2) }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" class="empty-state">Keine Bestellungen gefunden.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </section>

    <section id="contacts" style="margin-top:2rem;">
        <h3>Letzte Konversationen (Timeline, neueste zuerst)</h3>
        <ul class="timeline">
            {% if last_conversations %}
                {% for c in last_conversations %}
                <li>
                    {{ c.conversation_time and c.conversation_time.strftime('%Y-%m-%d %H:%M') or '—' }} &nbsp;
                    {{ c.channel or '—' }}: {{ c.subject or (c.notes[:60] if c.notes else '—') }}
                    {% if c.user %} - (Mitarbeiter: {{ c.user.name or '—' }}){% endif %}
                </li>
                {% endfor %}
            {% else %}
                <li>Keine Konversationen gefunden.</li>
            {% endif %}
        </ul>
    </section>

    <section id="master" style="margin-top:2rem;">
        <h3>Stammdaten</h3>
        <div><strong>Name:</strong> {{ customer.first_name or '—' }} {{ customer.last_name or '—' }}</div>
        <div><strong>E-Mail:</strong> {{ customer.email or '—' }}</div>
        <div><strong>Telefon:</strong> {{ customer.phone or '—' }}</div>
        <div><strong>Erstellt am:</strong> {{ customer.created_at and customer.created_at.strftime('%Y-%m-%d %H:%M') or '—' }}</div>
    </section>

</div>

{% endblock %}
